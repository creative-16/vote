<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voter Registration</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center p-6 bg-teal-700">

  <div class="relative w-full max-w-4xl bg-teal-700 rounded-3xl shadow-2xl p-1">
    <div class="absolute left-0 top-0 h-full w-3 bg-teal-700 rounded-l-3xl"></div>

    <!-- Form container -->
    <div id="form-container" class="relative w-full bg-white shadow-xl rounded-2xl p-8">
      <h2 class="text-3xl font-bold text-center text-pink-600">Voter Registration</h2>
      <p class="text-gray-500 text-center mb-6">Please provide your details below to register</p>

      <form id="registrationForm" class="space-y-6">
        <!-- Full Name -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Full Name</label>
          <input type="text" id="fullname" placeholder="Enter your full name"
            class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
          <p class="text-red-500 text-sm mt-1 hidden" id="fullname-msg">Full name is required</p>
        </div>

        <!-- Username -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Username</label>
          <input type="text" id="username" placeholder="Enter your username"
            class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
          <p class="text-green-500 text-sm mt-1 hidden" id="username-available">Username available</p>
          <p class="text-red-500 text-sm mt-1 hidden" id="username-taken">Username already taken</p>
        </div>

        <!-- Password -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Password</label>
          <input type="password" id="password" placeholder="Enter password"
            class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
          <p class="text-red-500 text-sm mt-1 hidden" id="password-msg">Password is required</p>
        </div>

        <!-- Email + Phone -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Email</label>
            <input type="email" id="email" placeholder="Enter your email"
              class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            <p class="text-red-500 text-sm mt-1 hidden" id="email-msg">Email is required</p>
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Phone Number</label>
            <input type="tel" id="phone" placeholder="Enter your phone number" readonly
              class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none bg-gray-200 cursor-not-allowed" />
          </div>
        </div>

        <!-- DOB + Gender -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Date of Birth</label>
            <input type="date" id="dob"
              class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            <p class="text-red-500 text-sm mt-1 hidden" id="dob-msg">Date of birth is required</p>
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Gender</label>
            <select id="gender" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none"
              required>
              <option value="">Select gender</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
            <p class="text-red-500 text-sm mt-1 hidden" id="gender-msg">Gender is required</p>
          </div>
        </div>

        <!-- Address -->
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-pink-600">Address Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-medium mb-2">House Name / Number</label>
              <input type="text" id="house" placeholder="House name / number"
                class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">Town / Village</label>
              <input type="text" id="town" placeholder="Town or village"
                class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">City</label>
              <input type="text" id="city" placeholder="City"
                class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">District</label>
              <input type="text" id="district" placeholder="District"
                class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">State</label>
              <input type="text" id="state" placeholder="State"
                class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">Country</label>
              <input type="text" id="country" placeholder="Country"
                class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
            </div>

            <div class="md:col-span-2 flex justify-center">
              <div class="w-1/2">
                <label class="block text-gray-700 font-medium mb-2 text-center">Pincode</label>
                <input type="text" id="pincode" placeholder="Pincode"
                  class="w-full px-10 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none text-center"
                  required />
              </div>
            </div>
          </div>
        </div>

        <!-- Voter ID -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Voter ID / Unique ID</label>
          <input type="text" id="voterid" placeholder="Enter your Voter ID"
            class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-pink-400 outline-none" required />
        </div>

        <!-- Submit -->
        <button id="submitBtn" type="submit"
          class="w-full py-3 px-6 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-xl shadow-lg transition duration-300 ease-in-out flex justify-center items-center">
          <span id="btnText">Register</span>
          <svg id="loadingSpinner" class="animate-spin ml-2 h-5 w-5 text-white hidden"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 010 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"></path>
          </svg>
        </button>
      </form>
    </div>

    <!-- Success message -->
    <!-- Success Message Card -->
    <div id="success-message" class="hidden flex justify-center mt-6">
      <div
        class="bg-white shadow-xl rounded-2xl p-8 flex flex-col items-center justify-center w-full max-w-md transition-transform hover:scale-105 hover:shadow-2xl">

        <p class="text-2xl font-bold text-pink-600 mb-2 text-center">ðŸŽ‰ Registration Successful!</p>
        <p class="text-gray-700 mb-6 text-center">Your account has been created successfully.</p>
        <a href="index.html"
          class="inline-block px-8 py-3 bg-teal-600 text-white font-semibold rounded-xl shadow-lg hover:bg-teal-700 transition duration-300">
          Go to Voter Login
        </a>
      </div>
    </div>

  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsqxp46x8mwXRpThRdpxsskRM1ie4PNCg",
      authDomain: "vote-edb06.firebaseapp.com",
      projectId: "vote-edb06",
      storageBucket: "vote-edb06.appspot.com",
      messagingSenderId: "916721565065",
      appId: "1:916721565065:web:2a451c1b45173d8b127558"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const lastPhone = localStorage.getItem("lastPhone");
    if (lastPhone) {
      document.getElementById("phone").value = lastPhone;
    }

    const usernameInput = document.getElementById("username");
    const usernameAvailableMsg = document.getElementById("username-available");
    const usernameTakenMsg = document.getElementById("username-taken");

    usernameInput.addEventListener("input", async () => {
      const username = usernameInput.value.trim();
      if (!username) {
        usernameAvailableMsg.classList.add("hidden");
        usernameTakenMsg.classList.add("hidden");
        return;
      }

      const q = query(collection(db, "voters"), where("username", "==", username));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        usernameAvailableMsg.classList.remove("hidden");
        usernameTakenMsg.classList.add("hidden");
      } else {
        usernameTakenMsg.classList.remove("hidden");
        usernameAvailableMsg.classList.add("hidden");
      }
    });

    const form = document.getElementById("registrationForm");
    const submitBtn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const spinner = document.getElementById("loadingSpinner");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Validate fields
      const fields = ["fullname", "username", "password", "email", "dob", "gender", "house", "town", "city", "district", "state", "country", "pincode", "voterid"];
      let valid = true;
      fields.forEach(id => {
        const el = document.getElementById(id);
        const msg = document.getElementById(id + "-msg");
        if (!el.value.trim()) {
          msg?.classList.remove("hidden");
          valid = false;
        } else {
          msg?.classList.add("hidden");
        }
      });

      // Check username uniqueness again
      const username = usernameInput.value.trim();
      const q = query(collection(db, "voters"), where("username", "==", username));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) {
        usernameTakenMsg.classList.remove("hidden");
        usernameAvailableMsg.classList.add("hidden");
        valid = false;
      }

      if (!valid) return;

      btnText.textContent = "Registering...";
      spinner.classList.remove("hidden");
      submitBtn.disabled = true;

      try {
        const voterData = {
          fullname: document.getElementById("fullname").value.trim(),
          username: username,
          password: document.getElementById("password").value,
          email: document.getElementById("email").value.trim(),
          phone: lastPhone || "",
          dob: document.getElementById("dob").value,
          gender: document.getElementById("gender").value,
          address: {
            house: document.getElementById("house").value.trim(),
            town: document.getElementById("town").value.trim(),
            city: document.getElementById("city").value.trim(),
            district: document.getElementById("district").value.trim(),
            state: document.getElementById("state").value.trim(),
            country: document.getElementById("country").value.trim(),
            pincode: document.getElementById("pincode").value.trim(),
          },
          voterid: document.getElementById("voterid").value.trim(),
        };

        // Store under phone number as document ID
        await setDoc(doc(db, "voters", lastPhone), voterData);

        document.getElementById("form-container").classList.add("hidden");
        document.getElementById("success-message").classList.remove("hidden");
      } catch (error) {
        console.error(error);
      } finally {
        btnText.textContent = "Register";
        spinner.classList.add("hidden");
        submitBtn.disabled = false;
      }
    });
  </script>
</body>

</html>