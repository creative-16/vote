<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voter Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- firebase-init.js -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Add these two libraries for QR generation and image download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBsqxp46x8mwXRpThRdpxsskRM1ie4PNCg",
            authDomain: "vote-edb06.firebaseapp.com",
            projectId: "vote-edb06",
            storageBucket: "vote-edb06.appspot.com",
            messagingSenderId: "916721565065",
            appId: "1:916721565065:web:2a451c1b45173d8b127558",
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    </script>
</head>

<body
    class="bg-gradient-to-br from-pink-100 via-pink-200 to-pink-300 min-h-screen flex items-center justify-center p-4">
    <div id="dashboardContent" style="display: none;"></div>

    <!-- Main Container -->
    <div
        class="w-full max-w-screen-xl bg-white/30 backdrop-blur-md rounded-3xl flex flex-col md:flex-row shadow-2xl h-auto md:h-[90vh] border border-white/40">

        <!-- Sidebar -->
        <div
            class="w-full md:w-20 bg-orange-400 rounded-t-3xl md:rounded-l-3xl md:rounded-tr-none flex md:flex-col items-center justify-center md:justify-start py-4 md:py-6 gap-6 shadow-inner">
            <button onclick="openTab(0)" class="text-white text-2xl bg-white/80 rounded-xl p-3">üè†</button>
            <button onclick="openTab(1)" class="text-white text-2xl bg-white/80 rounded-xl p-3">üòä</button>
            <button onclick="openTab(2)" class="text-white text-2xl bg-white/80 rounded-xl p-3">üë§</button>
        </div>

        <!-- Content -->
        <div
            class="flex-1 bg-gradient-to-br from-teal-600 to-teal-800 p-4 md:p-6 rounded-b-3xl md:rounded-r-3xl md:rounded-bl-none overflow-y-auto">

            <!-- Tab 0 -->
            <div id="tab-0" class="tab-content h-full flex flex-col">
                <h2 class="text-white text-2xl font-bold mb-4">Voter Dashboard</h2>

                <!-- Responsive Grid Layout -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-2">

                    <!-- Left Column: Profile, Clock, Voting Status -->
                    <div class="flex flex-col gap-4">
                        <div id="profileCard"
                            class="bg-white shadow-lg rounded-xl p-4 cursor-pointer transition hover:scale-[1.02]"
                            onclick="openTab(2)">
                            <div class="flex items-center gap-3">
                                <img src="./pic/1.png" alt="V" class="w-12 h-12 rounded-full object-cover">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800" id="profileName">Loading...</h3>
                                    <p class="text-sm text-gray-500" id="profileDept">@username</p>
                                </div>
                            </div>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', async () => {
                                // Get references to the HTML elements
                                const profileNameEl = document.getElementById('profileName');
                                const profileDeptEl = document.getElementById('profileDept');

                                // Get the userId from sessionStorage
                                const userId = sessionStorage.getItem('userId');
                                if (!userId) {
                                    console.error('User not logged in. No userId found in sessionStorage.');
                                    profileNameEl.textContent = 'Guest';
                                    profileDeptEl.textContent = 'Not logged in';
                                    return;
                                }

                                try {
                                    // Initialize Firestore
                                    const db = firebase.firestore();
                                    const votersRef = db.collection('voters');

                                    // Create a query to find the user document where 'username' matches the userId
                                    const q = votersRef.where('username', '==', userId);
                                    const querySnapshot = await q.get();

                                    if (querySnapshot.empty) {
                                        console.error('No matching user document found.');
                                        profileNameEl.textContent = 'User Not Found';
                                        profileDeptEl.textContent = 'Error';
                                        return;
                                    }

                                    // Get the user data from the first (and only) matching document
                                    const userData = querySnapshot.docs[0].data();

                                    // Update the HTML with the fetched data
                                    // Use '||' to provide a fallback if the field is missing
                                    profileNameEl.textContent = userData.fullname || 'No Name Provided';
                                    profileDeptEl.textContent = `@${userData.username || 'no-username'}`;

                                } catch (error) {
                                    console.error('Error fetching user profile:', error);
                                    profileNameEl.textContent = 'Error';
                                    profileDeptEl.textContent = 'Could not load';
                                }
                            });
                        </script>

                        <!-- Clock -->
                        <div class="bg-white/100 rounded-2xl p-4 text-center" id="clock">
                            <div class="text-center text-gray-600">üóìÔ∏è <span id="date"></span></div>
                            <div class="text-3xl font-semibold" id="time"></div>
                            <div class="text-lg mt-1 text-gray-600" id="day"></div>
                        </div>

                        <!-- Voting Status Section -->
                        <div class="bg-white shadow-lg rounded-xl p-4">
                            <h2 class="text-lg font-semibold text-gray-800 mb-2">Voting Status</h2>
                            <div id="votingStatus" class="text-blue-600 font-medium text-md">
                                Loading status...
                            </div>
                        </div>
                    </div>

                    <!-- Middle Column: Announcements -->
                    <div class="flex flex-col gap-4">
                        <div class="bg-white/90 rounded-2xl p-4 shadow-md flex flex-col h-full overflow-hidden">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-lg font-bold text-pink-600 flex items-center gap-2">üì¢ Announcements
                                </h2>
                                <span class="text-xs text-gray-500">Latest Updates</span>
                            </div>
                            <div id="announcementList"
                                class="space-y-2 overflow-y-auto pr-1 custom-scrollbar flex-grow max-h-[250px]">
                                <div class="bg-pink-100 p-3 rounded-lg shadow text-sm text-gray-700">üÜï Welcome to
                                    iElect Platform!
                                </div>
                                <div class="bg-pink-100 p-3 rounded-lg shadow text-sm text-gray-700">‚ö†Ô∏è Election day is
                                    approaching.
                                </div>
                                <div class="bg-pink-100 p-3 rounded-lg shadow text-sm text-gray-700">üìå Nomination
                                    deadline: July
                                    25th</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Calendar -->
                    <div class="flex flex-col gap-4">
                        <div class="bg-white/70 rounded-2xl p-4 shadow-md relative h-full">
                            <div id="calendarContainer" class="text-black-800 w-full h-auto">
                                <div id="calendarView" class="flex flex-col">
                                    <!-- Header -->
                                    <div class="flex justify-between items-center mb-3">
                                        <button onclick="changeMonth(-1)"
                                            class="text-black bg-white hover:bg-orange-400 px-2 py-1 rounded-full text-sm">‚Äπ</button>
                                        <h2 id="monthYear" class="text-lg font-bold text-black"></h2>
                                        <button onclick="changeMonth(1)"
                                            class="text-black bg-white hover:bg-orange-400 px-2 py-1 rounded-full text-sm">‚Ä∫</button>
                                    </div>

                                    <!-- Week Days -->
                                    <div
                                        class="grid grid-cols-7 gap-1 text-center font-medium text-gray-700 text-xs mb-1">
                                        <div>Sun</div>
                                        <div>Mon</div>
                                        <div>Tue</div>
                                        <div>Wed</div>
                                        <div>Thu</div>
                                        <div>Fri</div>
                                        <div>Sat</div>
                                    </div>

                                    <!-- Days -->
                                    <div id="calendarDays" class="grid grid-cols-7 gap-1 text-center text-sm pb-2">
                                    </div>
                                </div>

                                <!-- Event Detail -->
                                <div id="eventView"
                                    class="absolute inset-0 bg-white/100 rounded-xl p-6 shadow-xl hidden flex-col justify-center items-center z-10">
                                    <h3 class="text-xl font-semibold text-teal-800 mb-2">üìå Event on <span
                                            id="selectedDate"></span>
                                    </h3>
                                    <p id="eventText" class="text-gray-700 text-center mb-4"></p>
                                    <button onclick="closeEvent()"
                                        class="mt-4 px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg shadow-md">‚¨Ö
                                        Back to Calendar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Tab 1 -->
            <div id="tab-1" class="tab-content hidden text-white">
                <h2 class="text-2xl font-bold mb-6 text-center">üòä Motivate Section</h2>

                <div class="grid md:grid-cols-2 gap-6 mt-8">
                    <!-- Button 1 -->
                    <div class="relative group">
                        <a href="https://team-ielect.github.io/motivate/home.html" target="_blank"
                            rel="noopener noreferrer"
                            class="block overflow-hidden rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl">
                            <div class="relative h-64">
                                <img src="./pic/btn1.jpg" alt="First Motivation" class="w-full h-full object-cover">
                                <div
                                    class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                </div>
                                <div
                                    class="absolute bottom-0 left-0 right-0 p-4 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                    <h3 class="text-xl font-bold text-white mb-2">Right to Vote</h3>
                                    <p class="text-white/90 text-sm">It is your Right to vote - a Right Vote:
                                        To Know More Click Here
                                    </p>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Button 2 -->
                    <div class="relative group">
                        <a href="https://team-ielect.github.io/motivate/quiz.html" target="_blank"
                            rel="noopener noreferrer"
                            class="block overflow-hidden rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105 hover:shadow-2xl">
                            <div class="relative h-64">
                                <img src="./pic/btn2.jpg" alt="Second Motivation" class="w-full h-full object-cover">
                                <div
                                    class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                </div>
                                <div
                                    class="absolute bottom-0 left-0 right-0 p-4 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                    <h3 class="text-xl font-bold text-white mb-2">Quiz Time</h3>
                                    <p class="text-white/90 text-sm">Evaluate your knowledge about election and voting
                                        system: To Know More Click Here</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tab 2 -->
            <div id="tab-2" class="tab-content hidden text-white">
                <h2 class="text-2xl font-bold mb-2">üë§ Profile</h2>
                <!-- PROFILE TAB CONTENT -->



                <!-- This is the new, compact profile section -->
                <div class="profile-container">
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="loading-spinner"></div>

                    <!-- Profile Card (initially hidden) -->
                    <div id="profile-card" class="glass-card">
                        <div class="card-header">
                            <div id="profile-pic" class="profile-pic">?</div>
                            <div class="user-info">
                                <h2 id="profile-fullname">Loading...</h2>
                                <p id="profile-username">@username</p>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="details-grid">
                                <div class="detail-item">
                                    <div class="icon">üìß</div>
                                    <div class="detail-content">
                                        <span class="detail-label">Email</span>
                                        <p id="profile-email">email@example.com</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="icon">üì±</div>
                                    <div class="detail-content">
                                        <span class="detail-label">Phone</span>
                                        <p id="profile-phone">+1234567890</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="icon">üë§</div>
                                    <div class="detail-content">
                                        <span class="detail-label">Gender</span>
                                        <p id="profile-gender">Not Specified</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="icon">üéÇ</div>
                                    <div class="detail-content">
                                        <span class="detail-label">Date of Birth</span>
                                        <p id="profile-dob">YYYY-MM-DD</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="icon">üìç</div>
                                    <div class="detail-content">
                                        <span class="detail-label">Pincode</span>
                                        <p id="profile-pincode">000000</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="voter-dashboard.html">
                                <button class="dashboard-btn">Go to Dashboard</button>
                            </a>
                        </div>
                    </div>

                    <!-- Error Message (initially hidden) -->
                    <div id="error-message" class="error-message">
                        <p>Could not load profile. Please try again later.</p>
                    </div>
                </div>
                <style>
                    /* Import a nice font */
                    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

                    .profile-container {
                        width: 100%;
                        max-width: 800px;
                        /* Increased width for desktop */
                        margin: 0 auto;
                        /* Center alignment */
                        position: relative;
                    }

                    /* Glass Card Design with more blur and transparency */
                    .glass-card {
                        background: rgba(255, 255, 255, 0.07);
                        /* More transparent */
                        backdrop-filter: blur(20px);
                        /* More blur */
                        -webkit-backdrop-filter: blur(20px);
                        border-radius: 20px;
                        border: 1px solid rgba(255, 255, 255, 0.18);
                        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
                        padding: 2rem;
                        color: #fff;
                        text-align: left;
                        opacity: 0;
                        /* Initially hidden for fade-in effect */
                        transform: translateY(20px);
                        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
                    }

                    /* Class to make card visible */
                    .glass-card.visible {
                        opacity: 1;
                        transform: translateY(0);
                    }

                    .card-header {
                        display: flex;
                        align-items: center;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                        padding-bottom: 1.5rem;
                        margin-bottom: 1.5rem;
                    }

                    .profile-pic {
                        background: rgba(255, 255, 255, 0.2);
                        color: #fff;
                        width: 70px;
                        height: 70px;
                        border-radius: 50%;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        font-size: 2rem;
                        font-weight: 600;
                        margin-right: 1.5rem;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                    }

                    .user-info h2 {
                        margin: 0;
                        font-size: 1.8rem;
                        font-weight: 600;
                    }

                    .user-info p {
                        margin: 0.25rem 0 0;
                        font-size: 1rem;
                        opacity: 0.8;
                    }

                    .card-body .details-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        /* Responsive grid */
                        gap: 1.2rem;
                    }

                    .detail-item {
                        display: flex;
                        align-items: center;
                        padding: 0.5rem 0;
                    }

                    .detail-item .icon {
                        font-size: 1.2rem;
                        margin-right: 1rem;
                        background: rgba(255, 255, 255, 0.1);
                        padding: 0.6rem;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        font-style: normal;
                        /* Ensure no italic styling */
                        transform: none;
                        /* Ensure no rotation */
                    }

                    .detail-content .detail-label {
                        font-size: 0.75rem;
                        text-transform: uppercase;
                        opacity: 0.7;
                        letter-spacing: 1px;
                    }

                    .detail-content p {
                        margin: 0.25rem 0 0;
                        font-size: 0.95rem;
                        font-weight: 500;
                    }

                    .card-footer {
                        margin-top: 2rem;
                        text-align: center;
                    }

                    .dashboard-btn {
                        background: #ffffff;
                        /* Solid white button for contrast */
                        color: #667eea;
                        /* Gradient color for text */
                        padding: 0.75rem 2.5rem;
                        border-radius: 50px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-decoration: none;
                        border: none;
                        box-shadow: 0 4px 15px 0 rgba(31, 38, 135, 0.2);
                    }

                    .dashboard-btn:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.4);
                    }

                    /* Loading Spinner */
                    .loading-spinner {
                        border: 5px solid rgba(255, 255, 255, 0.3);
                        border-radius: 50%;
                        border-top: 5px solid #fff;
                        width: 50px;
                        height: 50px;
                        animation: spin 1s linear infinite;
                        margin: 3rem auto;
                    }

                    @keyframes spin {
                        0% {
                            transform: rotate(0deg);
                        }

                        100% {
                            transform: rotate(360deg);
                        }
                    }

                    /* Error Message */
                    .error-message {
                        background: rgba(255, 0, 0, 0.2);
                        border: 1px solid rgba(255, 0, 0, 0.3);
                        backdrop-filter: blur(10px);
                        padding: 1.5rem;
                        border-radius: 15px;
                        text-align: center;
                        color: #fff;
                        display: none;
                        /* Hidden by default */
                    }
                </style>
                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        // Get references to HTML elements
                        const profileCard = document.getElementById('profile-card');
                        const loadingSpinner = document.getElementById('loading-spinner');
                        const errorMessage = document.getElementById('error-message');

                        // Get data fields
                        const profileFullname = document.getElementById('profile-fullname');
                        const profileUsername = document.getElementById('profile-username');
                        const profileEmail = document.getElementById('profile-email');
                        const profilePhone = document.getElementById('profile-phone');
                        const profileGender = document.getElementById('profile-gender');
                        const profileDob = document.getElementById('profile-dob');
                        const profilePincode = document.getElementById('profile-pincode');
                        const profilePic = document.getElementById('profile-pic');

                        // --- Fetch Profile Data ---
                        async function fetchProfile() {
                            // 1. Get userId from sessionStorage
                            const userId = sessionStorage.getItem('userId');
                            if (!userId) {
                                showError("User not logged in. Please log in again.");
                                return;
                            }

                            // 2. Show loading state
                            loadingSpinner.style.display = 'block';
                            profileCard.classList.remove('visible');
                            errorMessage.style.display = 'none';

                            try {
                                // 3. Query Firestore
                                const db = firebase.firestore();
                                const votersRef = db.collection('voters');
                                const q = votersRef.where('username', '==', userId);
                                const querySnapshot = await q.get();

                                if (querySnapshot.empty) {
                                    showError("Profile not found for this user.");
                                    return;
                                }

                                // 4. Get the user data
                                const userDoc = querySnapshot.docs[0];
                                const userData = userDoc.data();

                                // 5. Populate the HTML with the data
                                profileFullname.textContent = userData.fullname || 'N/A';
                                profileUsername.textContent = `@${userData.username || 'N/A'}`;
                                profileEmail.textContent = userData.email || 'N/A';
                                profilePhone.textContent = userData.phone || 'N/A';
                                profileGender.textContent = userData.gender || 'N/A';
                                profileDob.textContent = userData.dob || 'N/A';

                                // --- FIX: Safely access pincode from the 'address' sub-document ---
                                profilePincode.textContent = (userData.address && userData.address.pincode) ? userData.address.pincode : 'N/A';

                                // --- DESIGN: Set profile picture initial ---
                                const initial = userData.fullname ? userData.fullname.charAt(0).toUpperCase() : '?';
                                profilePic.textContent = initial;

                                // 6. Hide loader and show the profile card with animation
                                loadingSpinner.style.display = 'none';
                                profileCard.classList.add('visible');

                            } catch (err) {
                                console.error("Error fetching profile data:", err);
                                showError("An error occurred while fetching your profile. Please check the console.");
                            }
                        }

                        function showError(message) {
                            loadingSpinner.style.display = 'none';
                            profileCard.classList.remove('visible');
                            errorMessage.querySelector('p').textContent = message;
                            errorMessage.style.display = 'block';
                        }

                        // Initial fetch when the page loads
                        fetchProfile();
                    });
                </script>


                <!-- Section: Verify Voter -->
                <div class="verification-container">
                    <div id="verification-card" class="verification-card">
                        <!-- Content will be dynamically inserted here by JavaScript -->
                    </div>
                </div>

                <style>
                    /* --- Verification Section Styles --- */
                    .verification-container {
                        width: 100%;
                        max-width: 800px;
                        margin: 2rem auto 0;
                        position: relative;
                    }

                    .verification-card {
                        background: rgba(255, 255, 255, 0.07);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border-radius: 20px;
                        border: 1px solid rgba(255, 255, 255, 0.18);
                        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
                        padding: 2rem;
                        color: #fff;
                        text-align: center;
                        min-height: 150px;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        transition: all 0.4s ease;
                    }

                    /* --- Button Styles --- */
                    .verify-btn,
                    .verified-btn,
                    .submit-btn,
                    .cancel-btn {
                        padding: 0.75rem 2.5rem;
                        border-radius: 50px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: none;
                        text-decoration: none;
                        display: inline-block;
                    }

                    .verify-btn {
                        background: #f0ad4e;
                        color: #fff;
                        box-shadow: 0 4px 15px 0 rgba(240, 173, 78, 0.4);
                    }

                    .verify-btn:hover {
                        background: #ec971f;
                        transform: translateY(-3px);
                        box-shadow: 0 6px 20px 0 rgba(240, 173, 78, 0.6);
                    }

                    .verified-btn {
                        background: #5cb85c;
                        color: #fff;
                        cursor: not-allowed;
                        opacity: 0.8;
                    }

                    .submit-btn {
                        background: #5bc0de;
                        color: #fff;
                    }

                    .submit-btn:hover {
                        background: #46b8da;
                    }

                    .cancel-btn {
                        background: transparent;
                        color: #fff;
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        margin-right: 1rem;
                    }

                    .cancel-btn:hover {
                        background: rgba(255, 255, 255, 0.1);
                    }

                    /* --- Form Styles --- */
                    .form-wrapper {
                        width: 100%;
                        max-width: 400px;
                    }

                    .form-title {
                        margin-top: 0;
                        margin-bottom: 1.5rem;
                        font-size: 1.5rem;
                        font-weight: 500;
                    }

                    .input-group {
                        margin-bottom: 1.5rem;
                        text-align: left;
                    }

                    .input-group label {
                        display: block;
                        margin-bottom: 0.5rem;
                        font-weight: 500;
                        opacity: 0.9;
                    }

                    .aadhar-input {
                        width: 100%;
                        padding: 0.75rem 1rem;
                        border-radius: 10px;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        background: rgba(255, 255, 255, 0.1);
                        color: #fff;
                        font-size: 1rem;
                        box-sizing: border-box;
                    }

                    .aadhar-input::placeholder {
                        color: rgba(255, 255, 255, 0.5);
                    }

                    .aadhar-input:focus {
                        outline: none;
                        border-color: rgba(255, 255, 255, 0.4);
                        background: rgba(255, 255, 255, 0.15);
                    }

                    .form-actions {
                        display: flex;
                        justify-content: center;
                        gap: 1rem;
                    }

                    /* --- Modern Loading Spinner --- */
                    .modern-spinner {
                        width: 50px;
                        height: 50px;
                        border: 3px solid rgba(255, 255, 255, 0.1);
                        border-top-color: #fff;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }

                    @keyframes spin {
                        to {
                            transform: rotate(360deg);
                        }
                    }

                    /* --- Error Message --- */
                    .verification-error {
                        color: #ff6b6b;
                        text-align: center;
                        font-weight: 500;
                    }
                </style>

                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const verificationCard = document.getElementById('verification-card');
                        let userDocRef;

                        const getVerifyButtonHTML = () => `<button id="verify-btn" class="verify-btn">üîç Verify Your Identity</button>`;
                        const getVerifiedButtonHTML = () => `<button id="verified-btn" class="verified-btn" disabled>‚úÖ Identity Verified</button>`;
                        const getFormHTML = () => `
                        <div class="form-wrapper">
                            <h3 class="form-title">Enter Your Aadhar Number</h3>
                            <form id="aadhar-form">
                                <div class="input-group">
                                    <label for="aadhar-number">Aadhar Number</label>
                                    <input type="text" id="aadhar-number" class="aadhar-input" placeholder="XXXX XXXX XXXX" maxlength="14" required>
                                </div>
                                <div class="form-actions">
                                    <button type="button" id="cancel-btn" class="cancel-btn">Cancel</button>
                                    <button type="submit" class="submit-btn">Submit</button>
                                </div>
                            </form>
                        </div>
                    `;
                        const getLoadingHTML = () => `<div class="modern-spinner"></div>`;
                        const getErrorHTML = (message) => `<div class="verification-error">${message}</div>`;

                        async function checkVerificationStatus() {
                            const userId = sessionStorage.getItem('userId');
                            if (!userId) {
                                renderContent(getErrorHTML("User not logged in."));
                                return;
                            }
                            try {
                                const db = firebase.firestore();
                                const q = db.collection('voters').where('username', '==', userId);
                                const querySnapshot = await q.get();
                                if (querySnapshot.empty) {
                                    renderContent(getErrorHTML("User profile not found."));
                                    return;
                                }
                                const userDoc = querySnapshot.docs[0];
                                userDocRef = userDoc.ref;
                                const userData = userDoc.data();

                                if (userData.status && userData.status === 'verified') {
                                    renderContent(getVerifiedButtonHTML());
                                } else {
                                    renderContent(getVerifyButtonHTML());
                                    attachButtonListener();
                                }
                            } catch (err) {
                                console.error("Error checking verification status:", err);
                                renderContent(getErrorHTML("Could not check your status. Please refresh."));
                            }
                        }

                        function renderContent(html) {
                            verificationCard.innerHTML = html;
                        }
                        function attachButtonListener() {
                            const verifyBtn = document.getElementById('verify-btn');
                            if (verifyBtn) verifyBtn.addEventListener('click', showVerificationForm);
                        }
                        function showVerificationForm() {
                            renderContent(getFormHTML());
                            const aadharForm = document.getElementById('aadhar-form');
                            const cancelBtn = document.getElementById('cancel-btn');
                            const aadharInput = document.getElementById('aadhar-number');
                            aadharForm.addEventListener('submit', handleVerification);
                            cancelBtn.addEventListener('click', checkVerificationStatus);
                            aadharInput.addEventListener('input', formatAadharInput);
                        }

                        async function getNextSequentialBoothNumber() {
                            const db = firebase.firestore();
                            const startingBooth = 142;
                            const votersPerBooth = 50;
                            const verifiedVotersQuery = db.collection('voters').where('status', '==', 'verified');
                            const snapshot = await verifiedVotersQuery.get();
                            const verifiedCount = snapshot.size;
                            const boothNumber = startingBooth + Math.floor(verifiedCount / votersPerBooth);
                            return String(boothNumber);
                        }

                        // --- UPDATED handleVerification function ---
                        async function handleVerification(event) {
                            event.preventDefault();
                            const aadharInput = document.getElementById('aadhar-number');
                            const aadharNumber = aadharInput.value.trim().replace(/\s/g, '');

                            if (!aadharNumber || aadharNumber.length !== 12) {
                                alert("Please enter a valid 12-digit Aadhar number.");
                                return;
                            }

                            renderContent(getLoadingHTML());

                            try {
                                const db = firebase.firestore();
                                const duplicateAadharQuery = db.collection('voters').where('aadhar', '==', aadharNumber);
                                const duplicateSnapshot = await duplicateAadharQuery.get();
                                if (!duplicateSnapshot.empty) {
                                    throw new Error("This Aadhar number is already registered with another account.");
                                }

                                const userId = sessionStorage.getItem('userId');
                                const q = db.collection('voters').where('username', '==', userId);
                                const querySnapshot = await q.get();
                                if (querySnapshot.empty) throw new Error("User profile not found during verification.");

                                const userDoc = querySnapshot.docs[0];
                                userDocRef = userDoc.ref;

                                const assignedBoothNumber = await getNextSequentialBoothNumber();
                                const uniqueUid = await generateUniqueUid();

                                await userDocRef.update({
                                    aadhar: aadharNumber,
                                    status: 'verified',
                                    uid: uniqueUid,
                                    boothNumber: assignedBoothNumber
                                });

                                renderContent(getVerifiedButtonHTML());

                                // --- KEY FIX: Increased delay and added logging ---
                                console.log("Verification successful! Triggering QR slip generation in 1.5 seconds...");
                                setTimeout(() => {
                                    if (typeof window.checkStatusAndRender === 'function') {
                                        console.log("Calling window.checkStatusAndRender...");
                                        window.checkStatusAndRender();
                                    } else {
                                        console.error("window.checkStatusAndRender is not a function. QR slip will not update.");
                                    }
                                }, 1500); // Increased delay to 1500ms

                            } catch (err) {
                                console.error("Verification failed:", err);
                                renderContent(getErrorHTML(err.message));
                            }
                        }

                        async function generateUniqueUid() {
                            const db = firebase.firestore();
                            let isUnique = false;
                            let newUid;
                            while (!isUnique) {
                                newUid = Math.random().toString(36).substring(2, 10);
                                const q = db.collection('voters').where('uid', '==', newUid);
                                const snapshot = await q.get();
                                if (snapshot.empty) isUnique = true;
                            }
                            return newUid;
                        }
                        function formatAadharInput(e) {
                            let value = e.target.value.replace(/\s/g, '');
                            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                            e.target.value = formattedValue;
                        }

                        checkVerificationStatus();
                    });
                </script>

                <!-- Section: QR Slip Generator -->
                <div class="qr-slip-container">
                    <h2 class="section-title">üìÑ Your Voter Slip</h2>
                    <div id="qr-slip-card" class="qr-slip-card">
                        <!-- Content will be dynamically inserted here by JavaScript -->
                    </div>
                </div>

                <style>
                    /* Import a nice font */
                    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

                    /* --- QR Slip Section Styles --- */
                    .qr-slip-container {
                        width: 100%;
                        max-width: 800px;
                        margin: 2rem auto 0;
                        position: relative;
                        font-family: 'Poppins', sans-serif;
                    }

                    .section-title {
                        color: #fff;
                        text-align: center;
                        margin-bottom: 1.5rem;
                        font-size: 2rem;
                        font-weight: 600;
                    }

                    .qr-slip-card {
                        background: rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                        border-radius: 20px;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
                        padding: 2rem;
                        color: #fff;
                        text-align: center;
                        min-height: 150px;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        transition: all 0.4s ease;
                    }

                    /* --- Unverified Message Style --- */
                    .unverified-message {
                        text-align: center;
                        color: #f0ad4e;
                    }

                    .unverified-message i {
                        font-size: 2.5rem;
                        margin-bottom: 1rem;
                        display: block;
                    }

                    .unverified-message h3 {
                        margin: 0;
                        font-size: 1.5rem;
                        font-weight: 600;
                    }

                    .unverified-message p {
                        margin: 0.5rem 0 0;
                        opacity: 0.8;
                    }

                    /* --- Verified Slip Styles (The New Design) --- */
                    .slip-wrapper {
                        width: 100%;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }

                    .slip-content {
                        width: 100%;
                        max-width: 400px;
                        background: #ffffff;
                        color: #333;
                        border-radius: 15px;
                        padding: 2rem;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                        position: relative;
                        overflow: hidden;
                        text-align: left;
                    }

                    .slip-content::before {
                        content: '';
                        position: absolute;
                        top: -50%;
                        left: -50%;
                        width: 200%;
                        height: 200%;
                        background: repeating-linear-gradient(45deg,
                                transparent,
                                transparent 10px,
                                rgba(102, 126, 234, 0.03) 10px,
                                rgba(102, 126, 234, 0.03) 20px);
                        z-index: 1;
                    }

                    .slip-content>* {
                        position: relative;
                        z-index: 2;
                    }

                    .slip-header {
                        text-align: center;
                        border-bottom: 2px solid #f0f0f0;
                        padding-bottom: 1rem;
                        margin-bottom: 1.5rem;
                    }

                    .slip-header .logo {
                        font-size: 2rem;
                        font-weight: 700;
                        color: #667eea;
                        margin-bottom: 0.25rem;
                    }

                    .slip-header .subtitle {
                        font-size: 0.9rem;
                        color: #777;
                        margin: 0;
                        font-weight: 400;
                    }

                    .qr-code-container {
                        display: flex;
                        justify-content: center;
                        margin: 1.5rem 0;
                    }

                    #qrcode {
                        background: #fff;
                        padding: 0.5rem;
                        border-radius: 10px;
                        border: 1px solid #eee;
                    }

                    .slip-uid {
                        font-family: 'Courier New', Courier, monospace;
                        font-size: 1.1rem;
                        font-weight: 600;
                        color: #555;
                        text-align: center;
                        background: #f9f9f9;
                        padding: 0.75rem;
                        border-radius: 8px;
                        margin-bottom: 1.5rem;
                    }

                    .slip-footer {
                        font-size: 0.8rem;
                        color: #999;
                        text-align: center;
                        margin-top: 1.5rem;
                        padding-top: 1rem;
                        border-top: 1px solid #f0f0f0;
                    }

                    .download-btn {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: #fff;
                        border: none;
                        padding: 0.75rem 2rem;
                        border-radius: 50px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        margin-top: 1.5rem;
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    }

                    .download-btn:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
                    }

                    .download-btn:active {
                        transform: translateY(-1px);
                    }
                </style>

                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const qrSlipCard = document.getElementById('qr-slip-card');

                        const getUnverifiedHTML = () => `
                            <div class="unverified-message">
                                <i>‚ö†Ô∏è</i>
                                <h3>Verification Required</h3>
                                <p>Please verify your identity to generate your voter slip.</p>
                            </div>
                        `;

                        const getVerifiedHTML = (uid) => `
                            <div class="slip-wrapper">
                                <div class="slip-content" id="slip-to-download">
                                    <div class="slip-header">
                                        <div class="logo">iElect</div>
                                        <p class="subtitle">Official Voter Identity Slip</p>
                                    </div>
                                    <div class="qr-code-container">
                                        <div id="qrcode"></div>
                                    </div>
                                    <div class="slip-uid">UID: ${uid}</div>
                                    <div class="slip-footer">
                                        Printed on: ${getFormattedDateTime()}
                                    </div>
                                </div>
                                <button class="download-btn" id="download-btn">
                                    <span>‚¨á</span> Download Slip
                                </button>
                            </div>
                        `;

                        // --- Main Logic: Check status and render ---
                        // KEY CHANGE: Added "window." to make this function globally accessible.
                        window.checkStatusAndRender = async function () {
                            console.log("QR Slip: Checking status...");
                            const userId = sessionStorage.getItem('userId');
                            if (!userId) {
                                console.log("QR Slip: No userId found in sessionStorage.");
                                qrSlipCard.innerHTML = `<p class="unverified-message">User not logged in.</p>`;
                                return;
                            }

                            try {
                                const db = firebase.firestore();
                                const q = db.collection('voters').where('username', '==', userId);
                                const querySnapshot = await q.get();

                                if (querySnapshot.empty) {
                                    console.log("QR Slip: No user document found.");
                                    qrSlipCard.innerHTML = `<p class="unverified-message">User profile not found.</p>`;
                                    return;
                                }

                                const userData = querySnapshot.docs[0].data();
                                console.log("QR Slip: User data retrieved:", userData); // IMPORTANT LOG

                                if (userData.status && userData.status === 'verified' && userData.uid) {
                                    console.log("QR Slip: User is verified. Rendering slip.");
                                    qrSlipCard.innerHTML = getVerifiedHTML(userData.uid);
                                    setTimeout(() => {
                                        generateQRCode(userData.uid);
                                        attachDownloadListener(userData.uid);
                                    }, 100);
                                } else {
                                    console.log("QR Slip: User is NOT verified. Showing unverified message.");
                                    qrSlipCard.innerHTML = getUnverifiedHTML();
                                }
                            } catch (err) {
                                console.error("QR Slip: Error checking status:", err);
                                qrSlipCard.innerHTML = `<p class="unverified-message">Could not load status. Please refresh.</p>`;
                            }
                        }

                        function generateQRCode(text) {
                            new QRCode(document.getElementById("qrcode"), {
                                text: text,
                                width: 180,
                                height: 180,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        }

                        function attachDownloadListener(uid) {
                            const downloadBtn = document.getElementById('download-btn');
                            downloadBtn.addEventListener('click', () => {
                                const element = document.getElementById('slip-to-download');
                                const originalText = downloadBtn.innerHTML;
                                downloadBtn.innerHTML = 'Generating...';
                                downloadBtn.disabled = true;
                                setTimeout(() => {
                                    html2canvas(element, {
                                        backgroundColor: '#ffffff',
                                        scale: 2,
                                        useCORS: true,
                                        logging: false
                                    }).then(canvas => {
                                        const link = document.createElement('a');
                                        link.download = `iElect-Slip-${uid}.png`;
                                        link.href = canvas.toDataURL('image/png');
                                        link.click();
                                        downloadBtn.innerHTML = originalText;
                                        downloadBtn.disabled = false;
                                    }).catch(err => {
                                        console.error('html2canvas error:', err);
                                        alert('Failed to generate image. Please try again.');
                                        downloadBtn.innerHTML = originalText;
                                        downloadBtn.disabled = false;
                                    });
                                }, 500);
                            });
                        }

                        function getFormattedDateTime() {
                            const now = new Date();
                            const options = {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            };
                            return now.toLocaleDateString(undefined, options);
                        }

                        // Initial check when the page loads
                        window.checkStatusAndRender();
                    });
                </script>

            </div>

        </div>
    </div>
    </div>

    <!-- Tab JS -->
    <script>
        function openTab(index) {
            document.querySelectorAll(".tab-content").forEach((tab, i) => {
                tab.classList.toggle("hidden", i !== index);
            });
        }

        // Clock and Date
        function updateTimeOnly() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-IN', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            document.getElementById('time').textContent = time;
        }

        function updateDateAndDay() {
            const now = new Date();
            document.getElementById('date').textContent = now.toLocaleDateString('en-IN', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
            document.getElementById('day').textContent = now.toLocaleDateString('en-IN', { weekday: 'long' });
        }

        updateDateAndDay();
        updateTimeOnly();
        setInterval(updateTimeOnly, 1000);
        setInterval(updateDateAndDay, 60000);

        let db;
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        const events = {}; // Will be filled dynamically

        // Fetch events from Firestore
        async function fetchEventsFromFirestore() {
            try {
                const snapshot = await db.collection("events").get();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.date;       // format: "2025-08-15"
                    const title = data.title;     // example: "Review"
                    if (date && title) {
                        events[date] = `üìå ${title}`;
                    }
                });
                renderCalendar(); // Only render after events are loaded
            } catch (error) {
                console.error("Error fetching events:", error);
            }
        }

        // Calendar logic remains mostly the same
        let currentDate = new Date();

        function renderCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            const monthYear = document.getElementById('monthYear');
            calendarDays.innerHTML = "";

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayKey = new Date().toISOString().slice(0, 10);

            monthYear.textContent = currentDate.toLocaleString('default', { month: 'long' }) + ` ${year}`;

            for (let i = 0; i < firstDay; i++) {
                calendarDays.innerHTML += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isEvent = events.hasOwnProperty(dateKey);
                const isToday = dateKey === todayKey;

                let btnClass = "bg-white/80 text-black hover:bg-blue-200";
                if (isToday && isEvent) {
                    btnClass = "bg-yellow-600 text-white font-bold border border-yellow-800 shadow-md hover:bg-yellow-700";
                } else if (isToday) {
                    btnClass = "bg-pink-600 text-white font-bold border border-black shadow-md hover:bg-purple-400";
                } else if (isEvent) {
                    btnClass = "bg-purple-300 text-black font-bold border border-black/50 shadow-md hover:bg-pink-700";
                }

                calendarDays.innerHTML += `<button onclick="showEvent('${dateKey}')" class="${btnClass} py-1 rounded-md shadow-sm">${day}</button>`;
            }
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }

        function showEvent(dateKey) {
            document.getElementById('selectedDate').textContent = new Date(dateKey).toDateString();
            document.getElementById('eventText').textContent = events[dateKey] || "No events on this day.";
            document.getElementById('eventView').classList.remove('hidden');
        }

        function closeEvent() {
            document.getElementById('eventView').classList.add('hidden');
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const announcementList = document.getElementById("announcementList");
            if (!announcementList) return;

            try {

                const snapshot = await db.collection("announcements").orderBy("createdAt", "desc").get();


                // Clear existing
                announcementList.innerHTML = "";

                if (snapshot.empty) {
                    const div = document.createElement("div");
                    div.className = "bg-pink-100 p-3 rounded-lg shadow text-sm text-gray-700";
                    div.textContent = "üì≠ No announcements yet.";
                    announcementList.appendChild(div);
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();

                    const div = document.createElement("div");
                    div.className = "bg-pink-100 p-3 rounded-lg shadow text-sm text-gray-700";

                    // Handle undefined category gracefully
                    let prefix = "üì¢";
                    const category = (data.category || "").toLowerCase();
                    if (category === "warning") prefix = "‚ö†Ô∏è";
                    else if (category === "info") prefix = "‚ÑπÔ∏è";
                    else if (category === "update") prefix = "üÜï";
                    else if (category === "deadline") prefix = "üìå";
                    else if (category === "reminder") prefix = "üîî";

                    div.textContent = `${prefix} ${data.text || "No announcement text."}`;
                    announcementList.appendChild(div);
                });
            } catch (error) {
                console.error("Error fetching announcements:", error);
                const div = document.createElement("div");
                div.className = "bg-red-100 p-3 rounded-lg shadow text-sm text-red-700";
                div.textContent = "‚ö†Ô∏è Failed to load announcements.";
                announcementList.appendChild(div);
            }
            await fetchEventsFromFirestore(); // üî• This is the missing call!
        });


    </script>

    <!-- Scrollbar -->
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #ec4899;
            border-radius: 3px;
        }
    </style>

    <script src="auth-guard.js"></script>

</body>

</html>
